#!/usr/bin/env node

var update = require('../lib/update');
var entity = require('../lib/entity');
var query = require('../lib/query');
var sitepath = require ('../lib/sitepath');
var db = require('../lib/db');
var program = require('commander');
var pjson = require('../package.json');
var user = require('../lib/user');
var validator = require('validator');
var crypto = require('crypto');

function parse_sitepath(val) {
  var pth = new sitepath(null,null);
  pth.fromDottedPath(val);
  return pth;
}

program
  .version(pjson.version);

program
  .command('adduser [name] [fullname]')
  .description('create a user')
  .option("-p, --profile [text]", "Profile text")
  .option("--password [password]", "Password")
  .option("-u, --url [url]", "Profile URL")
  .option("-e, --email [email]", "Email")
  .option("--userroot [root]", "User Root path", parse_sitepath, new sitepath(['wh','users']))
  .action(function(name, fullname, options){
    var now = new Date();
    if (!(name && fullname)) {
      console.log('Name and fullname are required')
      return;
    }
    var ent = new entity.Entity();
    user.createUser(ent, options.userroot, name, fullname, now);

    ent.summary.abstract = options.profile || '';

    if (options.url) {
      if (validator.isURL(options.url)) {
        ent.summary.profileUrl = options.url;
      } else {
        console.log('invalid URL')
        return;
      }
    }

    if (options.email) {
      if (validator.isEmail(options.email)) {
        ent.data.email = options.email;
      } else {
        console.log('invalid Email')
        return;
      }
    }

    var pw;
    if (options.password) {
      pw = options.password;
    } else {
      var buf = crypto.randomBytes(6);
      pw = buf.toString('base64');
      console.log('Randomly generated password is:', pw)
    }
    user.encodePassword(pw, ent, function(err) {
      if (err) {
        console.log('error:')
        console.log(err);
        return;
      }
      
      update.createEntity(db, {}, ent, true, 
                           'cli', function(err, entity_id, revision_id, revision_num) {
        if (err) {
          console.log('error:');
          console.log(err);
        } else {
          console.log('Created');
          db.gunDatabase();
        }
      });
    });

  });

program
  .command('assign [name] [role]')
  .description('assign a user to a role')
  .option("--userroot [root]", "User Root path", parse_sitepath, new sitepath(['wh','users']))
  .action(function(name, role, options){
    if (!(name && role)) {
      console.log('Name and role are required')
      return;
    }
    update.assignUserToRole(db, {}, options.userroot.down(name), role,
                           'cli', function(err, entity_id, revision_id, revision_num) {
      if (err) {
        console.log('error:');
        console.log(err);
      } else {
        console.log('Created');
        db.gunDatabase();
      }
    });
  });

program
  .command('userinfo [name]')
  .description('information about the user')
  .option("--userroot [root]", "User Root path", parse_sitepath, new sitepath(['wh','users']))
  .action(function(name, options){
    if (!(name)) {
      console.log('Name is required')
      return;
    }
    console.log('--')
    var resp = query.permissions_for_user(db, options.userroot.down(name));
    resp.on('article', function(article) {
      console.log('Role: %s\tPermission: %s\tPath %s',
        article.role, article.permission, article.path.toDottedPath());
    });
    resp.on('error', function(err) {
      console.log('error:')
      console.log(err);
    });
    resp.on('end', function() {
      console.log('--');
      db.gunDatabase();
    });
  });

program
  .command('roleusers [role]')
  .description('information about the role')
  .action(function(role, options){
    if (!(role)) {
      console.log('Role is required')
      return;
    }
    console.log('--')
    var resp = query.list_users_in_role(db, role);
    resp.on('article', function(article) {
      console.log(article.user.toDottedPath());
    });
    resp.on('error', function(err) {
      console.log('error:')
      console.log(err);
    });
    resp.on('end', function() {
      console.log('--');
      db.gunDatabase();
    });
  });



program
  .command('roleinfo [role]')
  .description('information about the role')
  .action(function(role, options){
    if (!(role)) {
      console.log('Role is required')
      return;
    }
    console.log('--')
    var resp = query.list_permissions_in_role(db, role);
    resp.on('article', function(article) {
      console.log('Permission: %s\tPath %s', article.permission, article.path.toDottedPath());
    });
    resp.on('error', function(err) {
      console.log('error:')
      console.log(err);
    });
    resp.on('end', function() {
      console.log('--');
      db.gunDatabase();
    });
  });

program
  .command('deassign [name] [role]')
  .description('removes a user from a role')
  .option("--userroot [root]", "User Root path", parse_sitepath, new sitepath(['wh','users']))
  .action(function(name, role, options){
    if (!(name && role)) {
      console.log('Name and role are required')
      return;
    }
    update.removeUserFromRole(db, {}, options.userroot.down(name), role,
                           'cli', function(err, entity_id, revision_id, revision_num) {
      if (err) {
        console.log('error:');
        console.log(err);
      } else {
        console.log('Deleted');
        db.gunDatabase();
      }
    });
  });


program
  .command('permit [role] [permission] [path]')
  .description('add a permission to a role')
  .action(function(role, permission, path, options){
    if (!(permission && role && path)) {
      console.log('role, permission, and path are required')
      return;
    }
    update.addPermissionToRole(db, {}, role, permission, path,
                           'cli', function(err, entity_id, revision_id, revision_num) {
      if (err) {
        console.log('error:');
        console.log(err);
      } else {
        console.log('Created');
        db.gunDatabase();
      }
    });
  });

program
  .command('deny [role] [permission] [path]')
  .description('remove a permission from a role')
  .action(function(role, permission, path, options){
    if (!(permission && role && path)) {
      console.log('role, permission, and path are required')
      return;
    }
    update.removePermissionFromRole(db, {}, role, permission, path,
                           'cli', function(err, entity_id, revision_id, revision_num) {
      if (err) {
        console.log('error:');
        console.log(err);
      } else {
        console.log('Deleted');
        db.gunDatabase();
      }
    });
  });

program.parse(process.argv);