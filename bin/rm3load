#!/usr/bin/env node

var update = require('../lib/update');
var entity = require('../lib/entity');
var sitepath = require ('../lib/sitepath');
var db = require('../lib/db');
var program = require('commander');
var pjson = require('../package.json');

function parse_sitepath(val) {
  var pth = new sitepath(null,null);
  pth.fromDottedPath(val);
  return pth;
}

program
  .version(pjson.version)
  .option('-f, --file [infile]','Input file','-')
  .option('-p, --path [path]','Change the path to the new destination path',parse_sitepath)
  .parse(process.argv);

function loadData(parsedData) {
  console.log(parsedData);
  ent = new entity.Entity();
  ent.fromDb({rows: [parsedData]});
  if (program.path) {
    ent._path = program.path
  }
  update.createEntity(db, ent, true, 'loaded via rm3load', function(){
    console.log('done')
    db.gunDatabase();
  });
}

if (program.file === '-') {
  var stdin = process.stdin
  var inputChunks = [];

  stdin.setEncoding('utf8');
 
  stdin.on('readable', function () {
    var chunk = process.stdin.read();
    if (chunk !== null) {
      inputChunks.push(chunk);
    }
  });
 
  stdin.on('end', function () {
    var inputData = inputChunks.join();
    var parsedData = JSON.parse(inputData);
    loadData(parsedData);
  });
} else {
  var fs = require('fs');
  var inputData = fs.readFileSync(program.file);
  var parsedData = JSON.parse(inputData);
  loadData(parsedData);
}

ent = new entity.Entity();
